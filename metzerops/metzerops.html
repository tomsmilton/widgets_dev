<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Monitoring Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-moment/1.0.1/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #222;
            margin-bottom: 20px;
            font-size: 2em;
            font-weight: 600;
        }
        
        .upload-section {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
            flex: 1;
            min-width: 300px;
        }
        
        .upload-area:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        
        .upload-area.dragover {
            background: #e8e8e8;
            border-color: #666;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .upload-label {
            display: inline-block;
            padding: 10px 24px;
            background: #2563eb;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-weight: 500;
        }
        
        .upload-label:hover {
            background: #1d4ed8;
        }
        
        .time-config {
            background: #fafafa;
            border-radius: 8px;
            padding: 20px;
            min-width: 250px;
        }
        
        .time-config label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        
        .time-config input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95em;
        }
        
        .dashboard {
            display: none;
            gap: 20px;
            flex-direction: column;
        }
        
        .dashboard.active {
            display: flex;
        }
        
        .controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-section {
            margin-bottom: 20px;
        }
        
        .control-section h3 {
            color: #222;
            margin-bottom: 15px;
            font-size: 1em;
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #fafafa;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .stat-card.active {
            background: white;
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .stat-card h4 {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stat-card.active h4 {
            color: #2563eb;
        }
        
        .channel-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .stat-card.active .channel-indicator {
            background: #2563eb;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #222;
            margin-bottom: 10px;
        }
        
        .stat-unit {
            color: #888;
            font-size: 0.7em;
            margin-left: 4px;
            font-weight: 400;
        }
        
        .stat-details {
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
            margin-top: 12px;
        }
        
        .stat-table {
            display: table;
            width: 100%;
            border-collapse: collapse;
        }
        
        .stat-row {
            display: table-row;
        }
        
        .stat-row:not(:last-child) {
            border-bottom: 1px solid #e5e5e5;
        }
        
        .stat-cell {
            display: table-cell;
            padding: 4px 4px;
            text-align: right;
        }
        
        .stat-cell:first-child {
            text-align: left;
            font-weight: 500;
            color: #555;
        }
        
        .stat-header {
            font-weight: 600;
            color: #444;
            background: #f8f8f8;
        }
        
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            background: #fafafa;
            transition: background 0.2s ease;
            cursor: pointer;
        }
        
        .checkbox-item:hover {
            background: #f0f0f0;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            cursor: pointer;
            color: #555;
            font-size: 0.9em;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            height: 500px;
        }
        
        .btn {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .btn:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .upload-section {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Power Monitoring Dashboard</h1>
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".csv">
                    <label for="fileInput" class="upload-label">Choose CSV File</label>
                    <p style="margin-top: 12px; color: #666; font-size: 0.9em;">or drag and drop your CSV file here</p>
                </div>
                <div class="time-config">
                    <label for="startDateTime">Start Date/Time (optional)</label>
                    <input type="datetime-local" id="startDateTime" step="1">
                    <p style="margin-top: 8px; color: #999; font-size: 0.8em;">Leave empty to use seconds from start</p>
                </div>
            </div>
        </div>
        
        <div class="dashboard" id="dashboard">
            <div class="controls">
                <div class="control-section">
                    <h3>Channel Summary (click to toggle)</h3>
                    <div class="stats-grid" id="statsGrid"></div>
                </div>
                
                <div class="control-section">
                    <h3>Measurements</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="showVoltage">
                            <label for="showVoltage">Voltage (V)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showCurrent">
                            <label for="showCurrent">Current (A)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="showPower">
                            <label for="showPower">Power (W)</label>
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>Chart Controls</h3>
                    <button class="btn" onclick="resetZoom()" style="width: 100%; margin-bottom: 10px;">Reset Zoom</button>
                    <div style="font-size: 0.85em; color: #555; line-height: 1.6; background: #fafafa; padding: 10px; border-radius: 6px;">
                        <div style="margin-bottom: 4px;">🔍 <strong>Zoom:</strong> Mouse wheel</div>
                        <div style="margin-bottom: 4px;">📦 <strong>Box zoom:</strong> Alt + drag</div>
                        <div style="margin-bottom: 4px;">✋ <strong>Pan:</strong> Click & drag</div>
                        <div style="margin-bottom: 4px;">↔️ <strong>X-axis only:</strong> Shift + wheel</div>
                        <div style="margin-bottom: 4px;">↕️ <strong>Y-axis only:</strong> Ctrl + wheel</div>
                        <div>📱 <strong>Touch:</strong> Pinch to zoom</div>
                    </div>
                </div>
                
                <button class="btn" onclick="resetDashboard()" style="margin-top: 15px; width: 100%;">Load New File</button>
            </div>
            
            <div class="chart-container">
                <canvas id="chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let csvData = null;
        let chart = null;
        let channelCount = 0;
        let activeChannels = new Set();
        
        // File handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const dashboard = document.getElementById('dashboard');
        const startDateTimeInput = document.getElementById('startDateTime');
        
        // Update chart when datetime changes
        startDateTimeInput.addEventListener('change', () => {
            if (csvData) {
                updateChart();
            }
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'text/csv') {
                processFile(file);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        });
        
        function processFile(file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    csvData = results.data;
                    
                    // Clean headers (remove whitespace)
                    csvData = csvData.map(row => {
                        const cleanRow = {};
                        for (let key in row) {
                            cleanRow[key.trim()] = row[key];
                        }
                        return cleanRow;
                    });
                    
                    initializeDashboard();
                }
            });
        }
        
        function initializeDashboard() {
            // Detect number of channels
            const headers = Object.keys(csvData[0]);
            channelCount = 0;
            
            for (let i = 1; i <= 10; i++) {
                if (headers.some(h => h.includes(`Read Voltage ${i}`))) {
                    channelCount = i;
                } else {
                    break;
                }
            }
            
            // Initialize all channels as inactive (unchecked)
            activeChannels.clear();
            
            // Show dashboard
            uploadArea.style.display = 'none';
            dashboard.classList.add('active');
            
            // Add event listeners for measurement checkboxes after dashboard is shown
            ['showVoltage', 'showCurrent', 'showPower'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', () => {
                        updateChart();
                    });
                }
            });
            
            // Create stats cards and initialize
            updateStats();
            updateChart();
        }
        
        function toggleChannel(channelNum) {
            if (activeChannels.has(channelNum)) {
                activeChannels.delete(channelNum);
            } else {
                activeChannels.add(channelNum);
            }
            
            // Update card visual state
            const card = document.getElementById(`channel-card-${channelNum}`);
            if (activeChannels.has(channelNum)) {
                card.classList.add('active');
            } else {
                card.classList.remove('active');
            }
            
            updateChart();
        }
        
        function getTimeValues() {
            const startDateStr = startDateTimeInput.value;
            
            if (startDateStr) {
                const startDate = new Date(startDateStr);
                return csvData.map(row => {
                    const date = new Date(startDate.getTime() + row.Time * 1000);
                    return date;
                });
            } else {
                return csvData.map(row => row.Time);
            }
        }
        
        function updateChart() {
            const datasets = [];
            const colors = [
                '#2563eb', '#dc2626', '#16a34a', '#ca8a04', '#9333ea', '#0891b2',
                '#be123c', '#0d9488', '#7c2d12', '#1e3a8a'
            ];
            
            const showVoltage = document.getElementById('showVoltage').checked;
            const showCurrent = document.getElementById('showCurrent').checked;
            const showPower = document.getElementById('showPower').checked;
            
            const timeValues = getTimeValues();
            const useDateTime = startDateTimeInput.value !== '';
            
            // Determine axis configuration based on what's being plotted
            const measurementCount = [showVoltage, showCurrent, showPower].filter(x => x).length;
            let voltageAxis = 'y';
            let currentAxis = 'y';
            let powerAxis = 'y';
            
            if (measurementCount === 2) {
                // Two measurements: use left and right axes
                if (showVoltage && showCurrent) {
                    voltageAxis = 'y1';  // voltage on right
                    currentAxis = 'y';    // current on left
                } else if (showVoltage && showPower) {
                    voltageAxis = 'y1';   // voltage on right
                    powerAxis = 'y';      // power on left
                } else if (showCurrent && showPower) {
                    powerAxis = 'y1';     // power on right
                    currentAxis = 'y';    // current on left
                }
            } else if (measurementCount === 3) {
                // Three measurements: voltage on right, current and power on left
                voltageAxis = 'y1';
                currentAxis = 'y';
                powerAxis = 'y';
            }
            
            for (let i = 1; i <= channelCount; i++) {
                if (!activeChannels.has(i)) continue;
                
                const voltageKey = `Read Voltage ${i}`;
                const currentKey = `Read Current ${i}`;
                const baseColor = colors[(i - 1) % colors.length];
                
                if (showVoltage) {
                    datasets.push({
                        label: `Ch${i} Voltage (V)`,
                        data: csvData.map((row, idx) => ({
                            x: timeValues[idx],
                            y: row[voltageKey]
                        })),
                        borderColor: baseColor,
                        backgroundColor: baseColor + '20',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 0,
                        borderDash: [5, 5],
                        yAxisID: voltageAxis
                    });
                }
                
                if (showCurrent) {
                    datasets.push({
                        label: `Ch${i} Current (A)`,
                        data: csvData.map((row, idx) => ({
                            x: timeValues[idx],
                            y: row[currentKey]
                        })),
                        borderColor: baseColor,
                        backgroundColor: baseColor + '40',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 0,
                        borderDash: [2, 2],
                        yAxisID: currentAxis
                    });
                }
                
                if (showPower) {
                    datasets.push({
                        label: `Ch${i} Power (W)`,
                        data: csvData.map((row, idx) => ({
                            x: timeValues[idx],
                            y: (row[voltageKey] || 0) * (row[currentKey] || 0)
                        })),
                        borderColor: baseColor,
                        backgroundColor: baseColor + '60',
                        borderWidth: 3,
                        tension: 0.1,
                        pointRadius: 0,
                        yAxisID: powerAxis
                    });
                }
            }
            
            const ctx = document.getElementById('chart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            // Build scales configuration
            const scales = {
                x: {
                    type: useDateTime ? 'time' : 'linear',
                    display: true,
                    title: {
                        display: true,
                        text: useDateTime ? 'Time' : 'Time (seconds)'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    time: useDateTime ? {
                        displayFormats: {
                            millisecond: 'HH:mm:ss',
                            second: 'HH:mm:ss',
                            minute: 'HH:mm',
                            hour: 'HH:mm',
                            day: 'MMM dd',
                            week: 'MMM dd',
                            month: 'MMM yyyy',
                            quarter: 'MMM yyyy',
                            year: 'yyyy'
                        }
                    } : undefined,
                    ticks: useDateTime ? {
                        callback: function(value, index, ticks) {
                            const date = new Date(value);
                            const dateStr = date.toDateString();
                            
                            // Check all previous ticks to see if this date has been shown
                            let isNewDay = true;
                            for (let i = 0; i < index; i++) {
                                const prevDate = new Date(ticks[i].value);
                                if (prevDate.toDateString() === dateStr) {
                                    isNewDay = false;
                                    break;
                                }
                            }
                            
                            // Show full date for first occurrence of each day
                            if (isNewDay) {
                                return moment(date).format('MMM D, h:mm a');
                            } else {
                                return moment(date).format('h:mm a');
                            }
                        },
                        maxRotation: 45,
                        autoSkip: true,
                        autoSkipPadding: 10
                    } : undefined
                },
                y: {
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: getLeftAxisLabel()
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            };
            
            // Add right y-axis if needed
            if ((measurementCount === 2) || (measurementCount === 3 && showVoltage)) {
                scales.y1 = {
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: getRightAxisLabel()
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                };
            }
            
            function getLeftAxisLabel() {
                const labels = [];
                if (measurementCount === 1) {
                    if (showVoltage) return 'Voltage (V)';
                    if (showCurrent) return 'Current (A)';
                    if (showPower) return 'Power (W)';
                } else if (measurementCount === 2) {
                    if (showCurrent && showPower) return 'Current (A)';
                    if (showVoltage && showCurrent) return 'Current (A)';
                    if (showVoltage && showPower) return 'Power (W)';
                } else if (measurementCount === 3) {
                    return 'Current (A) / Power (W)';
                }
                return 'Value';
            }
            
            function getRightAxisLabel() {
                if (measurementCount === 2) {
                    if (showCurrent && showPower) return 'Power (W)';
                    if (showVoltage && (showCurrent || showPower)) return 'Voltage (V)';
                } else if (measurementCount === 3) {
                    return 'Voltage (V)';
                }
                return 'Value';
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toFixed(3);
                                    return label;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    speed: 0.15,
                                    modifierKey: null
                                },
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                    borderColor: 'rgba(37, 99, 235, 0.5)',
                                    borderWidth: 1,
                                    modifierKey: 'alt'
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy',
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy',
                                modifierKey: null,
                                rangeMin: {
                                    x: null,
                                    y: null
                                },
                                rangeMax: {
                                    x: null,
                                    y: null
                                }
                            },
                            limits: {
                                x: {min: 'original', max: 'original'},
                                y: {min: 'original', max: 'original'}
                            }
                        }
                    },
                    scales: scales
                }
            });
        }
        
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            
            const colors = [
                '#2563eb', '#dc2626', '#16a34a', '#ca8a04', '#9333ea', '#0891b2',
                '#be123c', '#0d9488', '#7c2d12', '#1e3a8a'
            ];
            
            for (let i = 1; i <= channelCount; i++) {
                const voltageKey = `Read Voltage ${i}`;
                const currentKey = `Read Current ${i}`;
                const color = colors[(i - 1) % colors.length];
                
                // Calculate energy (power integrated over time)
                let totalEnergy = 0;
                for (let j = 1; j < csvData.length; j++) {
                    const power = (csvData[j][voltageKey] || 0) * (csvData[j][currentKey] || 0);
                    const timeDiff = csvData[j].Time - csvData[j-1].Time;
                    totalEnergy += power * timeDiff;
                }
                // Convert from Ws to Wh
                totalEnergy = totalEnergy / 3600;
                
                // Calculate values
                const voltages = csvData.map(row => row[voltageKey] || 0);
                const currents = csvData.map(row => row[currentKey] || 0);
                const powers = csvData.map((row, idx) => voltages[idx] * currents[idx]);
                
                const avgVoltage = voltages.reduce((a, b) => a + b, 0) / voltages.length;
                const avgCurrent = currents.reduce((a, b) => a + b, 0) / currents.length;
                const avgPower = powers.reduce((a, b) => a + b, 0) / powers.length;
                const maxVoltage = Math.max(...voltages);
                const maxCurrent = Math.max(...currents);
                const maxPower = Math.max(...powers);
                
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.id = `channel-card-${i}`;
                statCard.onclick = () => toggleChannel(i);
                statCard.innerHTML = `
                    <h4>
                        Channel ${i}
                        <span class="channel-indicator" style="background: ${color}"></span>
                    </h4>
                    <div class="stat-value">${totalEnergy.toFixed(2)}<span class="stat-unit">Wh</span></div>
                    <div class="stat-details">
                        <div class="stat-table">
                            <div class="stat-row stat-header">
                                <div class="stat-cell"></div>
                                <div class="stat-cell">Avg</div>
                                <div class="stat-cell">Max</div>
                            </div>
                            <div class="stat-row">
                                <div class="stat-cell">Voltage</div>
                                <div class="stat-cell">${avgVoltage.toFixed(2)} V</div>
                                <div class="stat-cell">${maxVoltage.toFixed(2)} V</div>
                            </div>
                            <div class="stat-row">
                                <div class="stat-cell">Current</div>
                                <div class="stat-cell">${avgCurrent.toFixed(3)} A</div>
                                <div class="stat-cell">${maxCurrent.toFixed(3)} A</div>
                            </div>
                            <div class="stat-row">
                                <div class="stat-cell">Power</div>
                                <div class="stat-cell">${avgPower.toFixed(2)} W</div>
                                <div class="stat-cell">${maxPower.toFixed(2)} W</div>
                            </div>
                        </div>
                    </div>
                `;
                statsGrid.appendChild(statCard);
            }
        }
        
        function resetZoom() {
            if (chart) {
                chart.resetZoom();
            }
        }
        
        function resetDashboard() {
            dashboard.classList.remove('active');
            uploadArea.style.display = 'block';
            fileInput.value = '';
            startDateTimeInput.value = '';
            if (chart) {
                chart.destroy();
                chart = null;
            }
            csvData = null;
            activeChannels.clear();
        }
    </script>
</body>
</html>